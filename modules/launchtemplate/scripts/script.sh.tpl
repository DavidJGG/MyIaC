#!/bin/bash
yum install -y amazon-efs-utils
yum install -y nfs-utils
efs_id=${efs_id}
mkdir -p "/mnt/efs/fs1"
test -f "/sbin/mount.efs" && printf "\n${efs_id}:/ /mnt/efs/fs1 efs tls,_netdev\n" >> /etc/fstab || printf "\n${efs_id}.efs.us-east-1.amazonaws.com:/ /mnt/efs/fs1 nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport,_netdev 0 0\n" >> /etc/fstab
test -f "/sbin/mount.efs" && grep -ozP 'client-info]\nsource' '/etc/amazon/efs/efs-utils.conf'; if [[ $? == 1 ]]; then printf "\n[client-info]\nsource=liw\n" >> /etc/amazon/efs/efs-utils.conf; fi;
retryCnt=15; waitTime=30; while true; do mount -a -t efs,nfs4 defaults; if [ $? = 0 ] || [ $retryCnt -lt 1 ]; then echo File system mounted successfully; break; fi; echo File system not available, retrying to mount.; ((retryCnt--)); sleep $waitTime; done; >> ~/resultado.txt
yum install nginx -y
systemctl enable nginx
systemctl start nginx
echo "IyBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBjb25maWd1cmF0aW9uLCBzZWU6CiMgICAqIE9mZmljaWFsIEVuZ2xpc2ggRG9jdW1lbnRhdGlvbjogaHR0cDovL25naW54Lm9yZy9lbi9kb2NzLwojICAgKiBPZmZpY2lhbCBSdXNzaWFuIERvY3VtZW50YXRpb246IGh0dHA6Ly9uZ2lueC5vcmcvcnUvZG9jcy8KCnVzZXIgbmdpbng7Cndvcmtlcl9wcm9jZXNzZXMgYXV0bzsKZXJyb3JfbG9nIC92YXIvbG9nL25naW54L2Vycm9yLmxvZyBub3RpY2U7CnBpZCAvcnVuL25naW54LnBpZDsKCiMgTG9hZCBkeW5hbWljIG1vZHVsZXMuIFNlZSAvdXNyL3NoYXJlL2RvYy9uZ2lueC9SRUFETUUuZHluYW1pYy4KaW5jbHVkZSAvdXNyL3NoYXJlL25naW54L21vZHVsZXMvKi5jb25mOwoKZXZlbnRzIHsKICAgIHdvcmtlcl9jb25uZWN0aW9ucyAxMDI0Owp9CgpodHRwIHsKICAgIGxvZ19mb3JtYXQgIG1haW4gICckcmVtb3RlX2FkZHIgLSAkcmVtb3RlX3VzZXIgWyR0aW1lX2xvY2FsXSAiJHJlcXVlc3QiICcKICAgICAgICAgICAgICAgICAgICAgICckc3RhdHVzICRib2R5X2J5dGVzX3NlbnQgIiRodHRwX3JlZmVyZXIiICcKICAgICAgICAgICAgICAgICAgICAgICciJGh0dHBfdXNlcl9hZ2VudCIgIiRodHRwX3hfZm9yd2FyZGVkX2ZvciInOwoKICAgIGFjY2Vzc19sb2cgIC92YXIvbG9nL25naW54L2FjY2Vzcy5sb2cgIG1haW47CgogICAgc2VuZGZpbGUgICAgICAgICAgICBvbjsKICAgIHRjcF9ub3B1c2ggICAgICAgICAgb247CiAgICBrZWVwYWxpdmVfdGltZW91dCAgIDY1OwogICAgdHlwZXNfaGFzaF9tYXhfc2l6ZSA0MDk2OwoKICAgIGluY2x1ZGUgICAgICAgICAgICAgL2V0Yy9uZ2lueC9taW1lLnR5cGVzOwogICAgZGVmYXVsdF90eXBlICAgICAgICBhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07CgogICAgIyBMb2FkIG1vZHVsYXIgY29uZmlndXJhdGlvbiBmaWxlcyBmcm9tIHRoZSAvZXRjL25naW54L2NvbmYuZCBkaXJlY3RvcnkuCiAgICAjIFNlZSBodHRwOi8vbmdpbngub3JnL2VuL2RvY3Mvbmd4X2NvcmVfbW9kdWxlLmh0bWwjaW5jbHVkZQogICAgIyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgIGluY2x1ZGUgL2V0Yy9uZ2lueC9jb25mLmQvKi5jb25mOwoKICAgIHNlcnZlciB7CiAgICAgICAgbGlzdGVuICAgICAgIDgwOwogICAgICAgIGxpc3RlbiAgICAgICBbOjpdOjgwOwogICAgICAgIHNlcnZlcl9uYW1lICBfOwogICAgICAgIHJvb3QgICAgICAgICAvbW50L2Vmcy9mczEvd2ViYXBwL2h0bWw7CgogICAgICAgICMgTG9hZCBjb25maWd1cmF0aW9uIGZpbGVzIGZvciB0aGUgZGVmYXVsdCBzZXJ2ZXIgYmxvY2suCiAgICAgICAgaW5jbHVkZSAvZXRjL25naW54L2RlZmF1bHQuZC8qLmNvbmY7CgogICAgICAgIGVycm9yX3BhZ2UgNDA0IC80MDQuaHRtbDsKICAgICAgICBsb2NhdGlvbiA9IC80MDQuaHRtbCB7CiAgICAgICAgfQoKICAgICAgICBlcnJvcl9wYWdlIDUwMCA1MDIgNTAzIDUwNCAvNTB4Lmh0bWw7CiAgICAgICAgbG9jYXRpb24gPSAvNTB4Lmh0bWwgewogICAgICAgIH0KICAgIH0KCiMgU2V0dGluZ3MgZm9yIGEgVExTIGVuYWJsZWQgc2VydmVyLgoKIyAgICBzZXJ2ZXIgewojICAgICAgICBsaXN0ZW4gICAgICAgNDQzIHNzbCBodHRwMjsKIyAgICAgICAgbGlzdGVuICAgICAgIFs6Ol06NDQzIHNzbCBodHRwMjsKIyAgICAgICAgc2VydmVyX25hbWUgIF87CiMgICAgICAgIHJvb3QgICAgICAgICAvbW50L2Vmcy9mczEvd2ViYXBwL2h0bWw7CgojICAgICAgICBzc2xfY2VydGlmaWNhdGUgIi9ldGMvcGtpL25naW54L3NlcnZlci5jcnQiOwojICAgICAgICBzc2xfY2VydGlmaWNhdGVfa2V5ICIvZXRjL3BraS9uZ2lueC9wcml2YXRlL3NlcnZlci5rZXkiOwojICAgICAgICBzc2xfc2Vzc2lvbl9jYWNoZSBzaGFyZWQ6U1NMOjFtOwojICAgICAgICBzc2wjX3Nlc3Npb25fdGltZW91dCAgMTBtOwojICAgICAgICBzc2xfY2lwaGVycyBQUk9GSUxFPVNZU1RFTTsKIyAgICAgICAgc3NsX3ByZWZlcl9zZXJ2ZXJfY2lwaGVycyBvbjsKCiAgICAgICAgIyBMb2FkIGNvbmZpZ3VyYXRpb24gZmlsZXMgZm9yIHRoZSBkZWZhdWx0IHNlcnZlciBibG9jay4KIyAgICAgICAgaW5jbHVkZSAvZXRjL25naW54L2RlZmF1bHQuZC8qLmNvbmY7CgojICAgICAgICBlcnJvcl9wYWdlIDQwNCAvNDA0Lmh0bWw7CiMgICAgICAgIGxvY2F0aW9uID0gLzQwNC5odG1sIHsKIyAgICAgICAgfQoKIyAgICAgICAgZXJyb3JfcGFnZSA1MDAgNTAyIDUwMyA1MDQgLzUweC5odG1sOwojICAgICAgICBsb2NhdGlvbiA9IC81MHguaHRtbCB7CiMgICAgICAgIH0KIyAgICB9Cgp9" | base64 --decode > /etc/nginx/nginx.conf
sudo systemctl restart nginx